version: '1.0'
stages:
  - checkout
  - package
  - test  
steps:
  main_clone:
    title: Cloning main repository...
    type: git-clone
    repo: '${{CF_REPO_OWNER}}/${{CF_REPO_NAME}}'
    revision: '${{CF_REVISION}}'
    stage: checkout
  flaskr:
    title: Building Docker Image
    type: build
    stage: package
    image_name: stabon/flaskr
    working_directory: ./
    tags:
      - latest
      - ${{CF_BRANCH_TAG_NORMALIZED_LOWER_CASE}}
      - ${{CF_SHORT_REVISION}}
    dockerfile: Dockerfile
  unit_tests:
    title: Running Unit tests
    image: '${{flaskr}}'
    stage: test 
    commands: 
      - pip install pytest
      - pytest
  deploy:
    title: Deploy to K8s
    type: deploy
    stage: deployment
    kind: kubernetes
    cluster: digitalOcean@k8s01demo
    namespace: flaskr
    service: flaskr
    candidate:
      image: '${{flaskr}}'
      registry: 'dockerhub'
